<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Office Uprising</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script> <!-- Atualizado para vers√£o mais recente -->
  <style>
    body { background:#f3f4f6; font-family:'Inter',sans-serif; overflow:hidden; }
    canvas { cursor:pointer; border-radius:0.75rem;
      box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
    .ui-panel { background:#fff; border-radius:0.75rem;
      box-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .tower-card.selected, .tower-card:hover { border-color:#3b82f6; background:#eff6ff; }
    .tower-card { transition:all .2s ease-in-out; border:2px solid transparent; }
    .modal { transition:opacity .3s ease, transform .3s ease; }
    .modal-hidden { opacity:0; transform:scale(.95); pointer-events:none; }
    .tower-card-img { width:48px; height:48px; background-size:contain; background-position:center; background-repeat:no-repeat; }
    .tooltip { position: absolute; background: #fff; border: 1px solid #ccc; padding: 8px; border-radius: 4px; display: none; z-index: 10; }
    .progress-bar { background: #e5e7eb; height: 8px; border-radius: 4px; margin-top: 8px; }
    .progress-fill { background: #3b82f6; height: 100%; border-radius: 4px; transition: width 0.3s; }
  </style>
</head>
<body class="flex flex-col xl:flex-row items-center justify-center min-h-screen p-4 gap-4">
  <!-- Painel -->
  <div class="ui-panel w-full xl:w-96 p-5 flex-shrink-0 order-2 xl:order-1 self-stretch flex flex-col">
    <h1 class="text-3xl font-bold text-gray-800 text-center mb-4">OFFICE UPRISING</h1>
    <div class="grid grid-cols-3 gap-3 text-center mb-4">
      <div class="bg-gray-100 p-2 rounded-lg">
        <div class="text-sm font-semibold text-gray-500">üìé Clipes</div>
        <div id="staples-amount" class="text-xl font-bold text-gray-800">200</div>
      </div>
      <div class="bg-gray-100 p-2 rounded-lg">
        <div class="text-sm font-semibold text-red-500">‚òïÔ∏è Pausas</div>
        <div id="health-amount" class="text-xl font-bold text-red-600">20</div>
      </div>
      <div class="bg-gray-100 p-2 rounded-lg">
        <div class="text-sm font-semibold text-blue-500">üåä Onda</div>
        <div id="wave-number" class="text-xl font-bold text-blue-600">0</div>
      </div>
    </div>
    <!-- Progresso da Onda -->
    <div id="wave-progress" class="progress-bar">
      <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
    </div>
    <!-- Loja -->
    <div id="tower-shop">
      <h2 class="text-lg font-semibold text-gray-700 mb-2">Defesas</h2>
      <div id="tower-selection" class="space-y-2"></div>
    </div>
    <!-- Upgrade -->
    <div id="upgrade-panel" class="hidden mt-4 pt-4 border-t">
      <h2 id="upgrade-tower-name" class="text-lg font-semibold text-gray-700 mb-2"></h2>
      <p class="text-sm text-gray-500 mb-2">N√≠vel: <span id="upgrade-tower-level"></span></p>
      <p class="text-sm text-gray-500 mb-3">Dano: <span id="upgrade-tower-damage"></span> | Alcance: <span id="upgrade-tower-range"></span></p>
      <button id="upgrade-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition"></button>
      <button id="sell-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition mt-2"></button>
    </div>
    <div class="flex-grow"></div>
    <div class="flex gap-2 mt-4">
      <button id="start-wave-btn" class="w-full bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 rounded-lg shadow-md transition-transform transform hover:scale-105">INICIAR ONDA</button>
      <div class="flex-shrink-0 flex gap-2">
        <button id="pause-btn" class="w-12 bg-gray-500 hover:bg-gray-600 text-white text-2xl font-bold py-3 rounded-lg shadow-md" disabled>‚è∏Ô∏è</button>
        <button id="speed-btn" class="w-12 bg-indigo-500 hover:bg-indigo-600 text-white text-xl font-bold py-3 rounded-lg shadow-md">1x</button>
        <button id="mute-btn" class="w-12 bg-yellow-500 hover:bg-yellow-600 text-white text-2xl font-bold py-3 rounded-lg shadow-md">üîä</button>
      </div>
    </div>
  </div>
  <!-- Jogo -->
  <div class="relative order-1 xl:order-2">
    <canvas id="gameCanvas" width="880" height="640"></canvas>
    <div id="modal" class="modal modal-hidden absolute inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center text-white text-center p-8 rounded-lg">
      <h2 id="modal-title" class="text-5xl font-bold mb-4"></h2>
      <div id="modal-content" class="text-lg mb-6 whitespace-pre-wrap"></div>
      <div id="modal-buttons"></div>
    </div>
  </div>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    // ---------- Offscreen para fundo ----------
    const bgCanvas = document.createElement('canvas');
    const bgCtx = bgCanvas.getContext('2d');
    bgCanvas.width = canvas.width; bgCanvas.height = canvas.height;
    // ---------- ASSETS ----------
    const ASSETS = { towers:{}, enemies:{} };
    const audio = {
      ready:false, muted:false, synths:{}, music:null,
      lastHitSoundTime:0, hitSoundInterval:0.05,
      lastShootSoundTime:0, shootSoundInterval:0.05 // Novo: throttle para shoot
    };
    const TILE_SIZE=40;
    const TOWER_RADIUS = TILE_SIZE/2 - 2;
    const MAX_PROJECTILES = 200; // Novo: limite de proj√©teis
    // ---------- Helpers ----------
    function createSvgImage(svg){ const img=new Image(); img.src='data:image/svg+xml;base64,'+btoa(svg); return img; }
    function clamp(v,min,max){ return v<min?min: v>max?max: v; }
    function pointSegmentDistance(x,y,x1,y1,x2,y2){
      const A=x-x1, B=y-y1, C=x2-x1, D=y2-y1;
      const dot=A*C+B*D, len=C*C+D*D;
      let t = len ? dot/len : -1;
      t = t<0?0: t>1?1:t;
      const xx=x1+t*C, yy=y1+t*D;
      const dx=x-xx, dy=y-yy;
      return Math.hypot(dx,dy);
    }
    function defineAssets(){
      // Torres (mesmas)
      ASSETS.towers.tack = [
        createSvgImage(`<svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)"><circle r="16" fill="#d1d5db"/><path d="M0 -14 L-4 4 L4 4 Z" fill="#ef4444"/><circle cy="-15" r="5" fill="#f87171"/></g></svg>`),
        createSvgImage(`<svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)"><circle r="17" fill="#9ca3af"/><g><path d="M0 -15 L-4 4 L4 4 Z" fill="#ef4444"/><circle cy="-16" r="5" fill="#f87171"/></g><g transform="rotate(120)"><path d="M0 -15 L-4 4 L4 4 Z" fill="#ef4444"/><circle cy="-16" r="5" fill="#f87171"/></g><g transform="rotate(240)"><path d="M0 -15 L-4 4 L4 4 Z" fill="#ef4444"/><circle cy="-16" r="5" fill="#f87171"/></g></g></svg>`),
        createSvgImage(`<svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><g transform="translate(20,20)"><circle r="18" fill="#4b5563"/><g><path d="M0 -16 L-5 5 L5 5 Z" fill="#dc2626"/><circle cy="-17" r="6" fill="#ef4444"/></g><g transform="rotate(72)"><path d="M0 -16 L-5 5 L5 5 Z" fill="#dc2626"/><circle cy="-17" r="6" fill="#ef4444"/></g><g transform="rotate(144)"><path d="M0 -16 L-5 5 L5 5 Z" fill="#dc2626"/><circle cy="-17" r="6" fill="#ef4444"/></g><g transform="rotate(216)"><path d="M0 -16 L-5 5 L5 5 Z" fill="#dc2626"/><circle cy="-17" r="6" fill="#ef4444"/></g><g transform="rotate(288)"><path d="M0 -16 L-5 5 L5 5 Z" fill="#dc2626"/><circle cy="-17" r="6" fill="#ef4444"/></g></g></svg>`)
      ];
      // ... (demais torres iguais, omitindo por brevidade)
      // Inimigos (mesmos)
      ASSETS.enemies.bug = createSvgImage('<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z" fill="#22c55e"/><path d="M12 2v20" stroke="#166534" stroke-width="1"/><path d="M9.5 8a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zm5 0a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" fill="#14532d"/><path d="M7 14s-2 2-4 2m14-2s2 2 4 2M7 10s-2-2-4-2m14 2s2-2 4-2" stroke="#14532d" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>');
      // ... (demais inimigos iguais)
    }
    function preloadAssets(cb){
      const list=[]; for (const t in ASSETS.towers) ASSETS.towers[t].forEach(i=>list.push(i)); for (const e in ASSETS.enemies) list.push(ASSETS.enemies[e]);
      if (!list.length) return cb();
      let n=0; const done=()=>{ if (++n===list.length) cb(); };
      list.forEach(img=>{ if (img.complete && img.naturalHeight!==0) done(); else { img.onload=done; img.onerror=done; }});
    }
    // ---------- Dificuldade / specs ----------
    const DIFFICULTY_SETTINGS={
      facil :{ startingStaples:250, startingHealth:25, enemyHealthMultiplier:0.8, towerCostMultiplier:0.9 },
      normal:{ startingStaples:200, startingHealth:20, enemyHealthMultiplier:1.0, towerCostMultiplier:1.0 },
      dificil:{ startingStaples:150, startingHealth:15, enemyHealthMultiplier:1.1, towerCostMultiplier:1.1 }, // Reduzido de 1.25 para 1.1
    };
    const SPEED_MULTIPLIERS=[1,2,4];
    const TOWER_SPECS={
      // Torres iguais, omitindo
    };
    const ENEMY_SPECS={
      // Inimigos iguais, omitindo
    };
    const MAPS = [
      // Mapas iguais, omitindo
    ];
    const PATH_STYLES = {
      // Estilos iguais, omitindo
    };
    // Ondas com redu√ß√£o em counts altos
    const WAVES=[];
    for (let i=0;i<50;i++){
      const w={enemies:[]}, complexity=Math.floor(i/5);
      w.enemies.push({type:'bug', count:Math.min(10+i*2, 50), delay:Math.max(15,50-i)});
      if (i>2) w.enemies.push({type:'glitch', count:Math.min(5+Math.floor(i/2), 30), delay:Math.max(40,100-i)});
      if (i>4) w.enemies.push({type:'crash', count:Math.min(3+complexity, 20), delay:Math.max(100,150-i)});
      if (i>9 && (i+1)%5===0) w.enemies.push({type:'boss', count:1+Math.floor((i-5)/5), delay:200});
      WAVES.push(w);
    }
    // ---------- Estado ----------
    let gameState = {
      staples:200, health:20, wave:0, mapIndex:0, status:'START',
      enemies:[], towers:[], projectiles:[],
      selectedTowerToPlace:null, selectedPlacedTower:null,
      waveInProgress:false, mouse:{x:0,y:0,down:false},
      currentWave:null, spawnTimer:0, spawnIndex:0,
      waveEndTimer:null, waveEndCountdown:10,
      difficulty:null, gameSpeed:1, speedIndex:0,
      totalEnemiesToSpawn:0, spawnedEnemies:0 // Novo: para progresso da onda
    };
    // ---------- UI refs ----------
    // ... (iguais, mais)
    const progressFill = document.getElementById('progress-fill');
    // ---------- GRID ESPACIAL ----------
    // ... (igual)
    // ---------- Classes ----------
    class Enemy {
      // ... (igual, mas com health escalonada reduzida: 1 + wave * 0.05)
      constructor(type){
        // ...
        this.health = this.spec.health * (1 + (gameState.wave * 0.05)) * gameState.difficulty.enemyHealthMultiplier;
        // ...
      }
      // ... resto igual
      takeDamage(v){
        this.health -= v;
        if (v>0) {
          playSound('hit','G2','32n');
          // Novo: part√≠culas simples em hit
          for (let i=0; i<5; i++) {
            gameState.projectiles.push(new Particle(this.x, this.y, Math.random()*Math.PI*2, 2+Math.random()*3, '#ef4444'));
          }
        }
        if (this.health<=0){ gameState.staples += this.spec.staples; return false; }
        return true;
      }
    }
    class Tower {
      constructor(x,y,type){ 
        // ...
        this.targetCooldown = 0; // Novo: cooldown para findTarget
      }
      // ...
      update(){
        if (this.fireCooldown>0) this.fireCooldown--;
        if (this.targetCooldown > 0) this.targetCooldown--;
        else { this.findTarget(); this.targetCooldown = 5; } // Busca a cada 5 frames
        // ... resto igual
      }
      // ... resto igual
    }
    class Projectile {
      // ... igual
    }
    class Particle { // Novo: classe para part√≠culas
      constructor(x, y, angle, speed, color) {
        this.x = x; this.y = y; this.angle = angle; this.speed = speed; this.color = color; this.life = 20;
      }
      update() {
        this.x += Math.cos(this.angle) * this.speed;
        this.y += Math.sin(this.angle) * this.speed;
        this.life--;
        return this.life > 0;
      }
      draw() {
        ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill();
      }
    }
    // ---------- Coloca√ß√£o (igual) ----------
    // ---------- Loop ----------
    function init(){
      // ... igual, mas adicionar save/load
      loadGame();
      // ...
    }
    function gameLoop(){ for (let i=0;i<gameState.gameSpeed;i++) update(); draw(); requestAnimationFrame(gameLoop); }
    function update(){
      // ... spawn igual, mas atualizar spawnedEnemies
      if (gameState.waveInProgress && gameState.spawnTimer === 0 && gameState.currentWave.enemies[gameState.spawnIndex]) {
        gameState.spawnedEnemies++;
      }
      // Limite proj√©teis
      if (gameState.projectiles.length > MAX_PROJECTILES) {
        gameState.projectiles = gameState.projectiles.slice(-MAX_PROJECTILES);
      }
      // Atualizar progresso
      if (gameState.totalEnemiesToSpawn > 0) {
        progressFill.style.width = `${(gameState.spawnedEnemies / gameState.totalEnemiesToSpawn) * 100}%`;
      }
      // ... resto igual
    }
    function draw(){
      // ... igual, mas desenhar part√≠culas (tratar como projectiles)
      // Proj√©teis incluem part√≠culas agora
    }
    // ---------- Fluxo das ondas ----------
    function startWave(){
      // ... igual
      gameState.totalEnemiesToSpawn = gameState.currentWave.enemies.reduce((sum, part) => sum + part.count, 0);
      gameState.spawnedEnemies = 0;
      // ...
    }
    function endWave(){
      // ... igual
      saveGame();
    }
    // Save/Load
    function saveGame() {
      localStorage.setItem('officeUprisingSave', JSON.stringify({
        staples: gameState.staples,
        health: gameState.health,
        wave: gameState.wave,
        mapIndex: gameState.mapIndex,
        towers: gameState.towers.map(t => ({x: t.x, y: t.y, type: t.type, level: t.level})),
        difficulty: gameState.difficulty
      }));
    }
    function loadGame() {
      const saved = localStorage.getItem('officeUprisingSave');
      if (saved) {
        const data = JSON.parse(saved);
        gameState.staples = data.staples;
        gameState.health = data.health;
        gameState.wave = data.wave;
        gameState.mapIndex = data.mapIndex;
        gameState.towers = data.towers.map(t => {
          const tower = new Tower(t.x, t.y, t.type);
          tower.level = t.level;
          return tower;
        });
        gameState.difficulty = data.difficulty;
        populateTowerShop();
        renderBackground();
      }
    }
    // ---------- √Åudio ----------
    function playSound(synthName,note,duration='16n'){
      if (!audio.ready || audio.muted) return;
      const now = Tone.now();
      if (synthName==='hit' && now < audio.lastHitSoundTime + audio.hitSoundInterval) return;
      if (synthName==='shoot' && now < audio.lastShootSoundTime + audio.shootSoundInterval) return;
      if (synthName==='hit') audio.lastHitSoundTime = now;
      if (synthName==='shoot') audio.lastShootSoundTime = now;
      if (audio.synths[synthName]) audio.synths[synthName].triggerAttackRelease(note,duration);
    }
    // ---------- UI / util ----------
    function populateTowerShop(){
      // ... igual, mas adicionar tooltips
      towerSelectionEl.innerHTML='';
      for (const key in TOWER_SPECS){
        // ...
        card.addEventListener('mouseover', () => {
          const tooltip = document.createElement('div');
          tooltip.className = 'tooltip';
          const stats = TOWER_SPECS[key].upgrades[0];
          tooltip.innerHTML = `Dano: ${stats.damage || 'N/A'}<br>Alcance: ${stats.range}<br>Taxa de Fogo: ${stats.fireRate}`;
          card.appendChild(tooltip);
          tooltip.style.display = 'block';
          tooltip.style.left = '100%';
          tooltip.style.top = '0';
        });
        card.addEventListener('mouseout', () => {
          const tooltip = card.querySelector('.tooltip');
          if (tooltip) tooltip.remove();
        });
        // ...
      }
    }
    function showModal(title,text,btnText,callback, showRestart=false){
      // ... igual, mas adicionar bot√£o restart se showRestart
      if (showRestart) {
        const restartBtn = document.createElement('button');
        restartBtn.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg text-xl mx-2';
        restartBtn.textContent = 'Reiniciar';
        restartBtn.onclick = () => { resetGame(); changeStatus('PLAYING'); };
        modalButtons.appendChild(restartBtn);
      }
    }
    // Em changeStatus para GAMEOVER/VICTORY: showModal(..., true) para showRestart
    function showDifficultySelection(){
      // ... igual
    }
    // Suporte touch: adicionar touch events
    canvas.addEventListener('touchstart', e => {
      const touch = e.touches[0];
      const r = canvas.getBoundingClientRect();
      gameState.mouse.x = touch.clientX - r.left;
      gameState.mouse.y = touch.clientY - r.top;
      // Simular click
      canvas.dispatchEvent(new MouseEvent('click', { clientX: touch.clientX, clientY: touch.clientY }));
    });
    canvas.addEventListener('touchmove', e => {
      const touch = e.touches[0];
      const r = canvas.getBoundingClientRect();
      gameState.mouse.x = touch.clientX - r.left;
      gameState.mouse.y = touch.clientY - r.top;
    });
    // ---------- Inicializa√ß√£o ----------
    init();
  </script>
</body>
</html>
